## 课程设计要求

### 功能要求

- [x] 将指令存储器和数据存储器分开,指令存储器的地址总线和数据总线宽度均为 16 位,数据存储器的地址总线宽度为 16 位,数据总线宽度为 8 位。
- [ ] CPU 使用流水线技术，流水级数为 5 级，分别是：取指、译码、执行、访存、写回。
- [x] 输入要求：模拟器从文件 test.data 读入汇编执行,先将汇编编译成二进制。
- [x] 输出要求：模拟器用 txt 文件记录每一个周期 CPU 主要寄存器的值，总线数值，程序执行完毕后，用 txt 文件记录数据存储器的内容。记录数据时要注意对齐。同时界面显示。

### 系统要求

- [ ] 简单方案：存储器读写操作只需要一个周期，不需要考虑控制信号；指令串行。
- [x] 中等方案：将指令分解成微指令。
- [ ] 高级方案，存储器读写操作采用 5 个周期，考虑指令流水。

### CPU 的主要寄存器及编址方式

- PC 寄存器，复位时的值为 0，16 位宽
- 16 个通用寄存器（r0~r15），对应地址为 0~15，复位时的值为 0，8 位宽
- 一个程序状态寄存器（sr，对应地址为 16），8 位宽
- 通用寄存器、程序状态寄存器和数据存储器统一编址，通用寄存器既可以用寄存器号访问，也可以用地址空间的地址访问

### 程序状态寄存器的格式

| 位位置     | 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| ---------- | --- | --- | --- | --- | --- | --- | --- | --- |
| 位名称     | I   | T   | H   | S   | V   | N   | Z   | C   |
| 读写属性   | R/W | R/W | R/W | R/W | R/W | R/W | R/W | R/W |
| 复位时的值 | 0   | 0   | 0   | 0   | 0   | 0   | 0   | 0   |

### 程序状态寄存器各位表示的意义

- I：全局中断允许位：为 1 时，允许中断，否则，禁止中断，CPU 响应中断时，硬件将此位清 0，从中断返回时，将此位置 1
- T：位复制存储位：BLD 指令用此位的值与 16 个通用寄存器中的某位交换值
- H：半进位标志：即低 4 位是否向高 4 位进位或借位，如果有则为 1，否则，为 0
- S：符号标志位：本位是位 N 和位 V 的异或值
- V：有符号数溢出标志位
- C：无符号数溢出标志位
- N：负数标志位：若运算结果是负数，则为 1；否则，为 0
- Z：0 标志位：若运算结果是 0，则为 1；否则，为 0

### 指令集

| 指令        | 功能               |
| ----------- | ------------------ |
| Add Rd , Rr | 加法指令           |
| Sub Rd , Rr | 减法指令           |
| Mul Rd , Rr | 无符号乘法指令     |
| RJMP K      | 无条件相对跳转指令 |
| BRMI K      | 有条件相对跳转指令 |
| Mov Rd , Rr | 数据传送指令       |
| Ldi Rd , K  | 载入立即数指令     |
| Ld Rd , X   | 装载指令           |
| St X, Rr    | 存储指令           |
| Nop         | 空操作指令         |

#### 加法指令

> add Rd, Rr

功能：Rd <- Rd+Rr

机器码（二进制表示）
0000 1100 dddd rrrr

其中，rrrr 为源操作数的寄存器号，dddd 为目的操作数的寄存器号

所影响的标志位
Z,C,N,V,H,S

#### 减法指令

> sub Rd, Rr

功能：Rd <- Rd-Rr

机器码（二进制表示）
0000 1000 dddd rrrr

其中，rrrr 为源操作数的寄存器号，dddd 为目的操作数的寄存器号

所影响的标志位
Z,C,N,V,H,S

#### 无符号乘法指令

> mul Rd, Rr

功能：R1:R0 <- Rd\*Rr

机器码（二进制表示）
1001 1100 dddd rrrr

其中，rrrr 为源操作数的寄存器号，dddd 为目的操作数的寄存器号

所影响的标志位
Z,C

#### 无条件相对跳转指令

> RJMP K

功能：PC<-PC+K+1

机器码（二进制表示）
1100 kkkk kkkk kkkk

其中， kkkk kkkk kkkk 为相对地址

所影响的标志位
无

#### 有条件相对跳转指令

> BRMI K

功能：if (N == 1) PC <- PC + k + 1

机器码（二进制表示）
1111 0001 kkkk kkkk

其中， kkkk kkkk 为相对地址

所影响的标志位
无

#### 数据传送指令

> mov Rd, Rr

功能：Rd <-Rr

机器码（二进制表示）
0010 1100 dddd rrrr

其中，rrrrr 为源操作数的寄存器号，ddddd 为目的操作数的寄存号

所影响的标志位
无

#### 载入立即数指令

> ldi Rd, K

功能：Rd <-K

机器码（二进制表示）
1110 KKKK dddd KKKK

其中，dddd 为目的操作数的寄存器号，目的寄存器只能是 r8~r15; KKKK KKKK 是立即数。

所影响的标志位
无

#### 装载指令

> ld Rd, X

功能：Rd <-（X）

机器码（二进制表示）
1001 0000 dddd 1100

其中，dddd 为目的操作数的寄存器号，X 为 R14 寄存器

所影响的标志位
无

#### 存储指令

> st X, Rr

功能 (X) <-Rr

机器码（二进制表示）
1001 0010 rrrr 1100

其中，rrrr 源操作数的寄存器号， X 为 R14：寄存器

所影响的标志位
无

#### 空操作指令

> nop

功能 不做任何操作，只消耗 CPU 时间

机器码（二进制表示）
0000 0000 0000 0000

所影响的标志位
无

### 各种操作需要的时间

乘法操作需要 3 个周期，其他操作需要 1 个周期
